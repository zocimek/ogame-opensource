# Introduction #

Как это было:<br>
<img src='http://ogamespec.com/imgstore/oldogame_messages.jpg'>

Доступ к игровым сообщениям осуществляется через меню <code>Сообщения</code>. Игровые сообщения могут быть сгенерированы игрой (шпионские и боевые доклады, сообщения о передвижении флотов и прочее) или другими игроками (например личные сообщения).<br>
<br>
Принципиальной разницы между типами сообщений нет, с одним различием: на личные сообщения можно пожаловаться оператору.<br>
<br>
Сообщение состоит из:<br>
<ul><li>Отправитель: указывается от кого пришло сообщение<br>
</li><li>Заголовок: тема сообщения<br>
</li><li>Тело: непосредственно сам текст сообщения</li></ul>

Все части сообщения хранятся в формате HTML, поэтому например в поле "Заголовок" может быть ссылка на боевой доклад.<br>
<br>
Теперь немного деталей о принципах работы:<br>
<br>
<ul><li>Всего у пользователя может быть не более 127 сообщений. Если происходит переполнение, то самое старое сообщение удаляется и добавляется новое.<br>
</li><li>Сообщение хранится 24 часа.<br>
</li><li>В личных сообщениях можно использовать BB-коды:<br>
<ul><li>Простые: b u i s sub sup hr<br>
</li><li>Цвет: <code>[color=ЦВЕТ][/color]</code>, размер <code>[size=РАЗМЕР][/size]</code>, шрифт <code>[font=FONT][/font]</code>, цитата <code>[quote=От кого][/quote]</code>
</li><li>URL: <code>[url=ПУТЬ][/url]</code>, Email: <code>[email=EMAIL][/email]</code>, Картинка <code>[img=путь][/img]</code>
</li><li>Выравнивание: <code>[align=left,right,center][/align]</code>
</li></ul></li><li>Если в "от кого", теме или тексте сообщения есть слово <b>{PUBLIC_SESSION}</b>, то при выводе оно заменяется на текущую сессию пользователя.<br>
</li><li>У каждого пользователя есть лимит сообщений в сутки. Выводится ошибка "Вы сегодня написали слишком много".</li></ul>

<h1>API</h1>

Движок находится в файле <code>game/msg.php</code>

Программный интерфейс предоставляемый движком сообщений:<br>
<br>
<b><code>DeleteExpiredMessages</code></b> : Удалить все старые сообщения (вызывается из меню Сообщения)<br>
<b><code>DeleteOldestMessage</code></b> : Удалить самое старое сообщение (вызывается из <code>SendMessage</code>)<br>
<b><code>SendMessage</code></b> : Послать сообщение. Возвращает id нового сообщения. (может вызываться откуда угодно)<br>
<b><code>DeleteMessage</code></b> : Удалить сообщение (вызывается из меню Сообщения)<br>
<b><code>EnumMessages</code></b> : Загрузить последние N сообщений (вызывается из меню Сообщения).<br>
<b><code>UnreadMessages</code></b> : Получить количество непрочитанных сообщений (вызывается из Обзора)<br>
<b><code>MarkMessage</code></b> : Пометить сообщение как прочтенное (вызывается из меню Сообщения).<br>
<br>
<h1>Database</h1>

Структура таблицы <code>messages</code> в БД:<br>
<br>
<table><thead><th> <b>столбец</b> </th><th> <b>SQL тип</b> </th><th> <b>описание</b> </th></thead><tbody>
<tr><td>msg_id                 </td><td>INT PRIMARY KEY    </td><td>Порядковый номер сообщения</td></tr>
<tr><td>owner_id               </td><td>INT                </td><td>Порядковый номер пользователя которому принадлежит сообщение</td></tr>
<tr><td>pm                     </td><td>INT                </td><td>Тип сообщения, 0: личное сообщение (можно пожаловаться оператору), ...</td></tr>
<tr><td>msgfrom                </td><td>TEXT               </td><td>От кого, HTML      </td></tr>
<tr><td>subj                   </td><td>TEXT               </td><td>Тема, HTML, может быть текст, может быть ссылка на доклад</td></tr>
<tr><td>text                   </td><td>TEXT               </td><td>Текст сообщения, HTML</td></tr>
<tr><td>shown                  </td><td>INT                </td><td>0 - новое сообщение, 1 - показанное.</td></tr>
<tr><td>date                   </td><td>INT UNSIGNED       </td><td>Дата сообщения</td></tr>